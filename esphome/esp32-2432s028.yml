############################################################
# SmartDisplay – ESPHome + LVGL lockscreen UI
#
# What this config does:
# - ESP32 drives an ILI9341 (320x240) TFT and an XPT2046 touchscreen
# - LVGL renders a simple "lockscreen" UI (time/date + 4 toggle buttons)
# - Buttons call Home Assistant services (light.toggle)
# - UI is refreshed on boot, every minute, and whenever HA light states change
#
# Notes for GitHub users:
# - Replace API/OTA secrets or move them to secrets.yaml
# - Make sure your display + touch wiring matches the SPI pins below
# - Touch calibration values are device-specific (you may need to adjust)
# - IMPORTANT: touchscreen.transform must match display.transform exactly
############################################################

# ==========================================================
# USER CONFIG (edit this section to match your HA setup)
#
# IMPORTANT:
# - All buttons currently use the Home Assistant service:
#     light.toggle
# - If you want to call a different service (e.g. switch.toggle,
#   script.turn_on, scene.turn_on, etc.), you must manually change
#   the "homeassistant.action" block inside each button below.
# - Only the entity IDs, labels and icons can be changed here.
# ==========================================================
substitutions:
  # Button 1
  BTN1_ENTITY: "light.buero_schreibtisch"
  BTN1_LABEL: "Tisch"
  BTN1_ICON: "\U000F095F"

  # Button 2
  BTN2_ENTITY: "light.buro_decke"
  BTN2_LABEL: "Decke"
  BTN2_ICON: "\U000F0769"

  # Button 3
  BTN3_ENTITY: "light.buero_kugel"
  BTN3_LABEL: "Kugel"
  BTN3_ICON: "\U000F08DD"

  # Button 4
  BTN4_ENTITY: "light.buro_schreibtisch_ambient_2"
  BTN4_LABEL: "Ambient"
  BTN4_ICON: "\U000F1051"
# ==========================================================

esphome:
  name: smartdisplay
  friendly_name: SmartDisplay
  # Trigger an initial UI sync shortly after boot
  on_boot:
    priority: 600
    then:
      - script.execute: ui_refresh

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logs over serial / network (useful for debugging)
logger:

# Home Assistant native API (encrypted)
api:
  encryption:
    key: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# OTA firmware updates
ota:
  - platform: esphome
    password: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Fallback hotspot if WiFi can't connect (lets you reconfigure)
  ap:
    ssid: "Smartdisplay Fallback Hotspot"
    password: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

captive_portal:

time:
  # Pull time from Home Assistant (used for clock/date labels)
  - platform: homeassistant
    id: homeassistant_time
    on_time:
      # Refresh UI every minute (at second 0) to keep time/date accurate
      - seconds: 0
        minutes: /1
        then:
          - script.execute: ui_refresh

font:
  # Large font for the clock
  - file: "gfonts://Roboto@500"
    id: big_text
    size: 60
    bpp: 4
    # Limit glyphs to reduce flash/RAM usage
    glyphs: ['&','@','!',',','.','?','"','%','(',')','+','-','_',':','°','0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z',' ','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','å','Ä','ä','Ö','ö','Ü','ü','/']

  # Smaller font for the date line
  - file: "gfonts://Roboto@300"
    id: notice_text
    size: 16
    bpp: 4
    glyphs: ['&','@','!',',','.','?','"','%','(',')','+','-','_',':','°','0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z',' ','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','å','Ä','ä','Ö','ö','Ü','ü','/']

  # Small font for the button captions
  - file: "gfonts://Roboto@400"
    id: label
    size: 13
    bpp: 4
    glyphs: ['&','@','!',',','.','?','"','%','(',')','+','-','_',':','°','0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z',' ','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','å','Ä','ä','Ö','ö','Ü','ü','/']

  # Material Design Icons (MDI) font file must exist in your ESPHome config folder
  # Download: https://github.com/Templarian/MaterialDesign-Webfont
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: materialdesign_icons
    size: 35
    # Only include the icons you use to keep the font small
    glyphs: ["\U000F095F", "\U000F0769", "\U000F08DD", "\U000F1051"]

color:
  # Used for icon highlight color
  - id: ACTIVE
    hex: "FEC600"
  # Used for default button background color (unchecked state)
  - id: INACTIVE
    hex: "808080"

sensor:
  - platform: wifi_signal
    name: "Wifi Signal"
    update_interval: 600s

  - platform: uptime
    name: "Uptime"
    id: uptime_s
    update_interval: 15s

binary_sensor:
  - platform: status
    name: "Node Status"
    id: system_status

  # Home Assistant entities mirrored as binary_sensors
  # Whenever a state changes, we refresh the UI so the button states match HA.
  - platform: homeassistant
    id: light_tisch
    entity_id: ${BTN1_ENTITY}
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_decke
    entity_id: ${BTN2_ENTITY}
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_kugel
    entity_id: ${BTN3_ENTITY}
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_ambient
    entity_id: ${BTN4_ENTITY}
    on_state:
      then:
        - script.execute: ui_refresh

text_sensor:
  # Human-readable uptime string (d/h/m/s)
  - platform: template
    name: "Uptime (formatted)"
    lambda: |-
      uint32_t dur = (uint32_t) id(uptime_s).state;
      int dys = 0;
      int hrs = 0;
      int mnts = 0;
      if (dur > 86399) { dys = trunc(dur / 86400); dur = dur - (dys * 86400); }
      if (dur > 3599)  { hrs = trunc(dur / 3600);  dur = dur - (hrs * 3600); }
      if (dur > 59)    { mnts = trunc(dur / 60);   dur = dur - (mnts * 60); }
      static char buffer[17];
      sprintf(buffer, "%ud %02uh %02um %02us", dys, hrs, mnts, dur);
      return {buffer};
    icon: mdi:clock-start
    update_interval: 60s

switch:
  # Expose a restart switch in Home Assistant
  - platform: restart
    name: "Restart"

spi:
  # SPI bus for the TFT display
  - id: lcd
    clk_pin: GPIO14
    mosi_pin: GPIO13
    miso_pin: GPIO12

  # Separate SPI bus for the touchscreen controller
  - id: my_touchscreen
    clk_pin: GPIO25
    mosi_pin: GPIO32
    miso_pin: GPIO39

output:
  # PWM output for TFT backlight brightness
  - platform: ledc
    pin: GPIO21
    id: gpio_backlight_pwm

  # RGB LED channels (inverted = common-anode / active-low wiring)
  - platform: ledc
    id: output_red
    pin: GPIO4
    inverted: true

  - platform: ledc
    id: output_green
    pin: GPIO16
    inverted: true

  - platform: ledc
    id: output_blue
    pin: GPIO17
    inverted: true

light:
  # Backlight as a monochromatic light entity (PWM)
  - platform: monochromatic
    output: gpio_backlight_pwm
    name: "Power Display Backlight"
    id: back_light
    restore_mode: ALWAYS_ON

  # On-board / external RGB LED as a light entity
  - platform: rgb
    name: LED
    red: output_red
    id: led
    green: output_green
    blue: output_blue
    restore_mode: ALWAYS_OFF

touchscreen:
  # XPT2046 resistive touch controller
  platform: xpt2046
  id: ts_touch
  spi_id: my_touchscreen
  cs_pin: 33
  interrupt_pin: 36
  update_interval: 50ms
  threshold: 400

  # Touch calibration: adjust these values for your specific panel/controller
  calibration:
    x_min: 280
    x_max: 3860
    y_min: 340
    y_max: 3860

  # IMPORTANT: must match the display transform so touch coordinates align
  transform:
    swap_xy: true
    mirror_x: false
    mirror_y: false

display:
  - platform: ili9xxx
    id: my_display
    spi_id: lcd
    model: ILI9341
    color_palette: 8BIT
    cs_pin: 15
    dc_pin: 2
    invert_colors: false
    # LVGL drives rendering, so we disable ESPHome's periodic display refresh
    update_interval: never
    auto_clear_enabled: false

    # Do not set "rotation" when using "transform"
    transform:
      swap_xy: true
      mirror_x: false
      mirror_y: false

    # Required when swap_xy is true (width/height swap)
    dimensions:
      width: 320
      height: 240

# --- LVGL UI ---
lvgl:
  # Bind LVGL to the configured display
  displays:
    - my_display
  # Bind LVGL to the configured touchscreen
  touchscreens:
    - touchscreen_id: ts_touch

  # Minimal theme: black background, rounded toggle buttons
  theme:
    obj:
      bg_color: 0x000000
      bg_opa: COVER

    # Rounded buttons: unchecked = INACTIVE gray, checked = white
    button:
      radius: 30
      width: 60
      height: 60
      border_width: 0
      shadow_width: 0
      bg_color: !lambda return id(INACTIVE);
      bg_opa: COVER
      checked:
        bg_color: 0xFFFFFF
        bg_opa: COVER

  pages:
    - id: lockscreen_page
      bg_color: 0x000000
      bg_opa: COVER
      widgets:
        # Date label (centered)
        - label:
            id: lbl_date
            x: 0
            y: 30
            width: 320
            text_align: CENTER
            text_font: notice_text
            text_color: 0xFFFFFF
            text: ""

        # Time label (centered, large)
        - label:
            id: lbl_time
            x: 0
            y: 55
            width: 320
            text_align: CENTER
            text_font: big_text
            text_color: 0xFFFFFF
            text: ""

        # Button 1: "${BTN1_LABEL}"
        - button:
            id: btn_tisch
            x: 25
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "${BTN1_ICON}"
            # Trigger HA service call on tap
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: ${BTN1_ENTITY}

        - label:
            x: 25
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "${BTN1_LABEL}"

        # Button 2: "${BTN2_LABEL}"
        - button:
            id: btn_decke
            x: 95
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "${BTN2_ICON}"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: ${BTN2_ENTITY}

        - label:
            x: 95
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "${BTN2_LABEL}"

        # Button 3: "${BTN3_LABEL}"
        - button:
            id: btn_kugel
            x: 165
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "${BTN3_ICON}"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: ${BTN3_ENTITY}

        - label:
            x: 165
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "${BTN3_LABEL}"

        # Button 4: "${BTN4_LABEL}"
        - button:
            id: btn_ambient
            x: 235
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "${BTN4_ICON}"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: ${BTN4_ENTITY}

        - label:
            x: 235
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "${BTN4_LABEL}"

script:
  # Central UI update routine:
  # - sets LVGL button checked state from HA light states
  # - updates time label
  # - updates date label
  - id: ui_refresh
    mode: queued
    then:
      # Update toggle button states (checked/un-checked)
      - lvgl.widget.update:
          id: btn_tisch
          state:
            checked: !lambda return id(light_tisch).state;

      - lvgl.widget.update:
          id: btn_decke
          state:
            checked: !lambda return id(light_decke).state;

      - lvgl.widget.update:
          id: btn_kugel
          state:
            checked: !lambda return id(light_kugel).state;

      - lvgl.widget.update:
          id: btn_ambient
          state:
            checked: !lambda return id(light_ambient).state;

      # Update time (HH:MM)
      - lvgl.label.update:
          id: lbl_time
          text: !lambda |-
            auto now = id(homeassistant_time).now();
            static char buf[6];
            snprintf(buf, sizeof(buf), "%02d:%02d", now.hour, now.minute);
            return std::string(buf);

      # Update date (German example: "Montag, 1. Januar")
      # Tip: If you want English, replace the arrays below.
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            static const char* days[]   = {"", "Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"};
            static const char* months[] = {"","Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"};
            auto now = id(homeassistant_time).now();
            static char buf[40];
            snprintf(buf, sizeof(buf), "%s, %d. %s", days[now.day_of_week], now.day_of_month, months[now.month]);
            return std::string(buf);