############################################################
# SmartDisplay (External ESP wiring variant) – ESPHome + LVGL lockscreen UI
#
# What this config does:
# - ESP32 drives an ILI9341 (320x240) TFT and an XPT2046 touchscreen
# - LVGL renders a simple "lockscreen" UI (time/date + 4 toggle buttons)
# - Buttons call Home Assistant services (light.toggle)
# - UI is refreshed on boot, every minute, and whenever HA light states change
#
# Hardware / wiring (IMPORTANT):
# - This variant keeps the PINOUT from the external-ESP YAML:
#   - Display SPI: CLK=GPIO18, MOSI=GPIO23, MISO=GPIO19
#   - Touch SPI:   CLK=GPIO25, MOSI=GPIO32, MISO=GPIO35
#   - Display: CS=GPIO27, DC=GPIO26, RESET=GPIO16
#   - Touch:   CS=GPIO33, IRQ=GPIO34
#   - Backlight PWM: GPIO4
#
# Notes for GitHub users:
# - Replace API/OTA secrets or move them to secrets.yaml
# - Touch calibration values are device-specific (you may need to adjust)
# - IMPORTANT: touchscreen.transform must match display.transform exactly
############################################################

esphome:
  name: smartdisplay
  friendly_name: SmartDisplay
  # Trigger an initial UI sync shortly after boot
  on_boot:
    priority: 600
    then:
      - script.execute: ui_refresh

############################################################
# ESP32 Configuration
############################################################
esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logs over serial / network (useful for debugging)
logger:

############################################################
# Home Assistant API (encrypted)
############################################################
api:
  encryption:
    key: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

############################################################
# OTA firmware updates
############################################################
ota:
  - platform: esphome
    password: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

############################################################
# WiFi Configuration
############################################################
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Fallback hotspot if WiFi can't connect (lets you reconfigure)
  ap:
    ssid: "Smartdisplay Fallback Hotspot"
    password: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

captive_portal:

############################################################
# Time from Home Assistant
# Used for clock + date display
############################################################
time:
  - platform: homeassistant
    id: homeassistant_time
    on_time:
      # Refresh UI every minute (at second 0) to keep time/date accurate
      - seconds: 0
        minutes: /1
        then:
          - script.execute: ui_refresh

############################################################
# Fonts
# Notes:
# - Using explicit glyph lists keeps font memory usage low.
# - MDI font must be placed in the ESPHome config directory (see link).
############################################################
font:
  # Large font for the clock
  - file: "gfonts://Roboto@500"
    id: big_text
    size: 60
    bpp: 4
    glyphs:
      ['&', '@', '!', ',', '.', '?', '"', '%', '(', ')', '+', '-', '_', ':', '°', '0',
       '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E',
       'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S',
       'T', 'U', 'V', 'W', 'X', 'Y', 'Z', ' ', 'a', 'b', 'c', 'd', 'e', 'f',
       'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
       'u', 'v', 'w', 'x', 'y', 'z','å', 'Ä', 'ä', 'Ö', 'ö', 'Ü', 'ü', '/']

  # Smaller font for the date line
  - file: "gfonts://Roboto@300"
    id: notice_text
    size: 16
    bpp: 4
    glyphs:
      ['&', '@', '!', ',', '.', '?', '"', '%', '(', ')', '+', '-', '_', ':', '°', '0',
       '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E',
       'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S',
       'T', 'U', 'V', 'W', 'X', 'Y', 'Z', ' ', 'a', 'b', 'c', 'd', 'e', 'f',
       'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
       'u', 'v', 'w', 'x', 'y', 'z','å', 'Ä', 'ä', 'Ö', 'ö', 'Ü', 'ü', '/']

  # Small font for the button captions
  - file: "gfonts://Roboto@400"
    id: label
    size: 13
    bpp: 4
    glyphs:
      ['&', '@', '!', ',', '.', '?', '"', '%', '(', ')', '+', '-', '_', ':', '°', '0',
       '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E',
       'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S',
       'T', 'U', 'V', 'W', 'X', 'Y', 'Z', ' ', 'a', 'b', 'c', 'd', 'e', 'f',
       'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
       'u', 'v', 'w', 'x', 'y', 'z','å', 'Ä', 'ä', 'Ö', 'ö', 'Ü', 'ü', '/']

  # Material Design Icons (MDI)
  # Download the font file and place it at: fonts/materialdesignicons-webfont.ttf
  # Source: https://github.com/Templarian/MaterialDesign-Webfont
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: materialdesign_icons
    size: 35
    # Only include the icons you use to keep the font small
    glyphs: ["\U000F095F", "\U000F0769", "\U000F08DD","\U000F1051"] # Download: https://github.com/Templarian/MaterialDesign-Webfont

############################################################
# UI Colors
############################################################
color:
  # Used for icon highlight color
  - id: ACTIVE
    hex: "FEC600"
  # Used for default button background color (unchecked state)
  - id: INACTIVE
    hex: "808080"

############################################################
# System Sensors
############################################################
sensor:
  - platform: wifi_signal
    name: "Wifi Signal"
    update_interval: 600s

  - platform: uptime
    name: "Uptime"
    id: uptime_s
    update_interval: 15s

############################################################
# Binary Sensors
# - status: device online status
# - homeassistant: mirror HA entities to drive LVGL button states
############################################################
binary_sensor:
  - platform: status
    name: "Node Status"
    id: system_status

  # Mirror HA entities as binary sensors so we can update LVGL "checked" state.
  # Whenever a state changes, we refresh the UI so the button states match HA.
  - platform: homeassistant
    id: light_tisch
    entity_id: light.buero_schreibtisch
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_decke
    entity_id: light.buro_decke
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_kugel
    entity_id: light.buero_kugel
    on_state:
      then:
        - script.execute: ui_refresh

  - platform: homeassistant
    id: light_ambient
    entity_id: light.buro_schreibtisch_ambient_2
    on_state:
      then:
        - script.execute: ui_refresh

############################################################
# Text Sensors
############################################################
text_sensor:
  # Human-readable uptime string (d/h/m/s)
  - platform: template
    name: "Uptime (formatted)"
    lambda: |-
      uint32_t dur = (uint32_t) id(uptime_s).state;
      int dys = 0;
      int hrs = 0;
      int mnts = 0;
      if (dur > 86399) { dys = trunc(dur / 86400); dur = dur - (dys * 86400); }
      if (dur > 3599)  { hrs = trunc(dur / 3600);  dur = dur - (hrs * 3600); }
      if (dur > 59)    { mnts = trunc(dur / 60);   dur = dur - (mnts * 60); }
      static char buffer[17];
      sprintf(buffer, "%ud %02uh %02um %02us", dys, hrs, mnts, dur);
      return {buffer};
    icon: mdi:clock-start
    update_interval: 60s

############################################################
# Convenience Switches
############################################################
switch:
  # Expose a restart switch in Home Assistant
  - platform: restart
    name: "Restart"

############################################################
# SPI Buses (External ESP pinout)
############################################################
spi:
  # Display SPI (external-ESP variant pinout)
  - id: lcd
    clk_pin: 18
    mosi_pin: 23
    miso_pin: 19

  # Touch SPI (external-ESP variant pinout)
  - id: my_touchscreen
    clk_pin: 25
    mosi_pin: 32
    miso_pin: 35

############################################################
# Outputs / Backlight
############################################################
output:
  # Backlight PWM (external-ESP variant pinout)
  - platform: ledc
    pin: 4
    id: gpio_backlight_pwm

light:
  # Backlight as a monochromatic light entity (PWM)
  - platform: monochromatic
    output: gpio_backlight_pwm
    name: "Power Display Backlight"
    id: back_light
    restore_mode: ALWAYS_ON

############################################################
# Touchscreen (XPT2046)
############################################################
touchscreen:
  platform: xpt2046
  id: ts_touch
  spi_id: my_touchscreen
  cs_pin: 33
  interrupt_pin: 34
  update_interval: 50ms
  threshold: 400

  # Touch calibration: adjust these values for your specific panel/controller
  calibration:
    x_min: 280
    x_max: 3860
    y_min: 340
    y_max: 3860

  # IMPORTANT: match the display transform exactly
  # If touch coordinates are mirrored/rotated, change BOTH transforms together.
  transform:
    swap_xy: true
    mirror_x: false
    mirror_y: false

############################################################
# Display (ILI9341)
############################################################
display:
  - platform: ili9xxx
    id: my_display
    spi_id: lcd
    model: ILI9341
    color_palette: 8BIT
    cs_pin: 27
    dc_pin: 26
    reset_pin: 16
    invert_colors: false
    # LVGL drives rendering, so we disable ESPHome's periodic display refresh
    update_interval: never
    auto_clear_enabled: false

    # Legacy file used rotation: 90.
    # In the LVGL version we use transform (and avoid rotation).
    transform:
      swap_xy: true
      mirror_x: false
      mirror_y: false

    # Required when swap_xy is true (width/height swap)
    dimensions:
      width: 320
      height: 240

# --- LVGL UI (replaces the legacy display lambda) ---
lvgl:
  # Bind LVGL to the configured display
  displays:
    - my_display
  # Bind LVGL to the configured touchscreen
  touchscreens:
    - touchscreen_id: ts_touch

  # Minimal theme: black background, rounded toggle buttons
  theme:
    obj:
      bg_color: 0x000000
      bg_opa: COVER

    # Rounded buttons: unchecked = INACTIVE gray, checked = white
    button:
      radius: 30
      width: 60
      height: 60
      border_width: 0
      shadow_width: 0
      bg_color: !lambda return id(INACTIVE);
      bg_opa: COVER
      checked:
        bg_color: 0xFFFFFF
        bg_opa: COVER

  pages:
    - id: lockscreen_page
      bg_color: 0x000000
      bg_opa: COVER
      widgets:
        # Date label (centered)
        - label:
            id: lbl_date
            x: 0
            y: 30
            width: 320
            text_align: CENTER
            text_font: notice_text
            text_color: 0xFFFFFF
            text: ""

        # Time label (centered, large)
        - label:
            id: lbl_time
            x: 0
            y: 55
            width: 320
            text_align: CENTER
            text_font: big_text
            text_color: 0xFFFFFF
            text: ""

        # Button 1: "Tisch" light
        - button:
            id: btn_tisch
            x: 25
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "\U000F095F"
            # Trigger HA service call on tap
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.buero_schreibtisch

        - label:
            x: 25
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "Tisch"

        # Button 2: "Decke" light
        - button:
            id: btn_decke
            x: 95
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "\U000F0769"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.buro_decke

        - label:
            x: 95
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "Decke"

        # Button 3: "Kugel" light
        - button:
            id: btn_kugel
            x: 165
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "\U000F08DD"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.buero_kugel

        - label:
            x: 165
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "Kugel"

        # Button 4: "Ambient" light
        - button:
            id: btn_ambient
            x: 235
            y: 140
            checkable: true
            widgets:
              - label:
                  align: CENTER
                  text_font: materialdesign_icons
                  text_color: !lambda return id(ACTIVE);
                  text: "\U000F1051"
            on_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.buro_schreibtisch_ambient_2

        - label:
            x: 235
            y: 205
            width: 60
            text_align: CENTER
            text_font: label
            text_color: 0xFFFFFF
            text: "Ambient"

############################################################
# UI Refresh Script
# Keeps buttons, time and date in sync with Home Assistant
############################################################
script:
  - id: ui_refresh
    mode: queued
    then:
      # Update toggle button states (checked/un-checked)
      - lvgl.widget.update:
          id: btn_tisch
          state:
            checked: !lambda return id(light_tisch).state;

      - lvgl.widget.update:
          id: btn_decke
          state:
            checked: !lambda return id(light_decke).state;

      - lvgl.widget.update:
          id: btn_kugel
          state:
            checked: !lambda return id(light_kugel).state;

      - lvgl.widget.update:
          id: btn_ambient
          state:
            checked: !lambda return id(light_ambient).state;

      # Update time (HH:MM)
      - lvgl.label.update:
          id: lbl_time
          text: !lambda |-
            auto now = id(homeassistant_time).now();
            static char buf[6];
            snprintf(buf, sizeof(buf), "%02d:%02d", now.hour, now.minute);
            return std::string(buf);

      # Update date (German example: "Montag, 1. Januar")
      # Tip: If you want English, replace the arrays below.
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            static const char* days[]   = {"", "Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"};
            static const char* months[] = {"","Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"};
            auto now = id(homeassistant_time).now();
            static char buf[40];
            snprintf(buf, sizeof(buf), "%s, %d. %s", days[now.day_of_week], now.day_of_month, months[now.month]);
            return std::string(buf);